<div loader ng-show="loading"></div>

<div style="float:right">
<form role="form" class="state-form">
    <label>Product:</label>
    <select ng-model="selected_product" ng-options="product as product for (product, rs) in required_signoffs" name="product">
    </select>
</form>
</div>
<h2>
  <span>{{ selected_product }} Signoff Requirements</span>

  <button class="btn btn-primary btn-xs" ng-click="addNewRequiredSignoff()">
    Enable Signoffs for a new Product
    <i class="glyphicon glyphicon-plus"></i>
  </button>
</h2>

<!-- todo: don't show if object is empty -->
<div class="panel panel-default" ng-show="required_signoffs[selected_product]['permissions']">
  <div class="panel-heading">
    <h3 class="panel-title">
      <span>
        <span ng-show="state === 'current'">To change {{ selected_product}} permissions you must have signoff from...</span>
          <button class="btn btn-xs btn-warning"
                  ng-click="editRequiredSignoffs('permissions')">
            Edit
          </button>
          <button class="btn btn-xs btn-danger"
                  ng-click="deleteRequiredSignoffs(required_signoffs, 'permissions')">
            Delete
          </button>
      </span>
    </h3>
  </div>
  <div class="panel-body">
    <!-- todo: try to find a way to sort this by non-pending first -->
    <div class="panel panel-default" ng-repeat="(role, details) in required_signoffs[selected_product]['permissions']">
      <div class="panel-heading">
        <h4 class="panel-title">
          <!-- show current + pending required signoffs -->
          <span>{{ details["signoffs_required"] }} member(s) of {{ role }}</span>
          <span class="label label-info" ng-show="details['sc'] !== null && details['sc']['change_type'] !== 'delete'">Pending</span>
          <span class="label label-danger" ng-show="details['sc'] !== null && details['sc']['change_type'] === 'delete'">Pending Delete</span>
          <div style="float: right" ng-show="details['sc'] !== null">
            <button class="btn btn-xs btn-primary" ng-click="signoff('permission', details['sc'], role)"
                    ng-show="! details['sc']['signoffs'].hasOwnProperty(current_user)">
              Signoff as...
            </button>
            <button class="btn btn-xs btn-danger" ng-click="revokeSignoff('permission', details['sc'], role)"
                    ng-show="details['sc']['signoffs'].hasOwnProperty(current_user)">
              Revoke your Signoff
            </button>
          </div>
        </h4>
      </div>
      <div class="panel-body" ng-show="details['sc'] !== null">
        <h4>Before it can be enacted, this change must be signed off on by:</h4>
        <ul>
          <li ng-repeat="(role, signoffs_required) in details['sc']['required_signoffs']">
            {{ signoffs_required }} members of {{ role }}
          </li>
        </ul>
        <h4 ng-show="details['sc'] !== null && ! isEmpty(details['sc']['signoffs'])">This change has already been signed off by:</h4>
        <ul>
          <li ng-repeat="(username, role) in details['sc']['signoffs']">
            {{ username }} ({{ role }})
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="panel panel-default" ng-repeat="(channel, roles) in required_signoffs[selected_product]['channels']">
  <div class="panel-heading">
    <h3 class="panel-title">
      <span>
        <span ng-show="state === 'current'">
          To change Rules or Releases on the {{ selected_product }} {{ channel }} channel, you must have signoff from...
        </span>
        <button class="btn btn-xs btn-warning"
                ng-click="editRequiredSignoffs('channel', channel)">
          Edit
        </button>
        <button class="btn btn-xs btn-danger"
                ng-click="deleteRequiredSignoffs(required_signoffs, 'channel', channel)">
          Delete
        </button>
      </span>
    </h3>
  </div>
  <div class="panel-body">
    <div class="panel panel-default" ng-repeat="(role, details) in roles">
      <div class="panel-heading">
        <h4 class="panel-title">
          <!-- add link to user roles ui here, when it exists -->
          <span>{{ details["signoffs_required"] }} member(s) of {{ role }}</span>
          <span class="label label-info" ng-show="details['sc'] !== null && details['sc']['change_type'] !== 'delete'">Pending</span>
          <span class="label label-danger" ng-show="details['sc'] !== null && details['sc']['change_type'] === 'delete'">Pending Delete</span>
          <div style="float: right" ng-show="details['sc']['sc_id'] !== null">
            <button class="btn btn-xs btn-primary" ng-click="signoff('channel', details['sc'], role, channel)"
                    ng-show="! details['sc']['signoffs'].hasOwnProperty(current_user)">
              Signoff as...
            </button>
            <button class="btn btn-xs btn-danger" ng-click="revokeSignoff('channel', details['sc'], role, channel)"
                    ng-show="details['sc']['signoffs'].hasOwnProperty(current_user)">
              Revoke your Signoff
            </button>
          </div>
        </h4>
      </div>
      <div class="panel-body" ng-show="details['sc'] !== null">
        <h4>Before it can be enacted, this change must be signed off on by:</h4>
        <ul>
          <li ng-repeat="(role, signoffs_required) in details['sc']['required_signoffs']">
            {{ signoffs_required }} members of {{ role }}
          </li>
        </ul>
        <h4 ng-show="details['sc'] !== null && ! isEmpty(details['sc']['signoffs'])">This change has already been signed off by:</h4>
        <ul>
          <li ng-repeat="(username, role) in details['sc']['signoffs']">
            {{ username }} ({{ role }})
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
